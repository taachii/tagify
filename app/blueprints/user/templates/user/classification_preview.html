{% extends 'dashboard_base.html' %}

{% block content %}
<div class="user-panel">
  <h2>Wyniki klasyfikacji</h2>

  <p><strong>Liczba zdjęć:</strong> {{ results|length }}</p>
  <p><strong>Model:</strong> {{ model_name|default('---') }}</p>

  <form method="POST" action="{{ url_for('user.generate_zip', token=download_token) }}" id="generateZipForm">
    <div class="preview-gallery">
      {% for item in results %}
      {% set confidence_level = (
        'low' if item.confidence < 0.4 else
        'mid' if item.confidence < 0.7 else
        'high'
      ) %}
      <div class="preview-item confidence-{{ confidence_level }}">
        <img src="{{ url_for('static', filename=item.static_path) }}" alt="{{ item.filename }}">
        <p><strong>{{ item.filename }}</strong></p>
        <p>Klasa: {{ item.predicted_label }}</p>
        <p>Pewność: {{ (item.confidence * 100) | round(1) }}%</p>

        <label for="corrections_{{ loop.index }}">Popraw klasę:</label>
        <select name="corrections[{{ item.filename }}]" id="corrections_{{ loop.index }}">
          {% for cls in ["animals", "buildings", "food", "landscape", "people", "plants", "vehicles"] %}
            <option value="{{ cls }}" {% if cls == item.predicted_label %}selected{% endif %}>{{ cls }}</option>
          {% endfor %}
        </select>
      </div>
      {% endfor %}
    </div>

    {% if not classification_expired and download_token %}
    <div style="margin-top: 2rem;">
      <button type="submit" class="btn">Wygeneruj ZIP z poprawkami</button>
    </div>
    {% endif %}
  </form>

  <!-- Spinner -->
  <div id="generatingSpinner" style="display: none; text-align: center; margin-top: 2em; margin-bottom: 2em;">
    <i class="fas fa-spinner fa-spin" style="font-size: 2em; color: #7f5af0;"></i>
    <p style="margin-top: 2em;">Trwa generowanie ZIP-a...</p>
  </div>

  <div style="margin-top: 2rem;">
    <a href="{{ url_for('user.classifications') }}" class="btn btn-outline">Historia klasyfikacji</a>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.getElementById("generateZipForm")?.addEventListener("submit", function () {
    document.getElementById("generatingSpinner").style.display = "block";
    document.body.style.cursor = "progress";

    const btn = document.querySelector('button[type="submit"]');
    if (btn) {
      btn.disabled = true;
      btn.textContent = "Generowanie ZIP-a...";
    }
  });
</script>
{% endblock scripts %}
